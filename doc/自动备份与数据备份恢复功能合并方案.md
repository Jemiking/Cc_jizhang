# 自动备份与数据备份恢复功能合并方案

## 背景

当前应用中，自动备份设置与数据备份恢复功能分散在不同页面，导致用户体验不连贯：
- 设置页面中有两个独立入口："数据备份与恢复"和"自动备份设置"
- 数据备份恢复页面中又包含了一个"自动备份设置"的按钮
- 功能分散导致用户可能忽略某些重要设置

## 目标

将自动备份设置与数据备份恢复功能合并到一个统一的界面中，提升用户体验：
1. 简化导航结构，减少重复入口
2. 集中相关功能，提供一致的备份管理体验
3. 优化备份文件管理和路径选择
4. 改进UI交互和状态反馈

## 实施计划

### 第一阶段：UI合并

[√] 1.1 修改设置页面，移除独立的"自动备份设置"入口
[√] 1.2 重构DataBackupScreen.kt，添加自动备份设置卡片
[√] 1.3 将AutoBackupSettingScreen中的UI组件迁移到DataBackupScreen
[√] 1.4 调整DataBackupScreen的布局，确保各功能区域清晰分隔
[√] 1.5 更新导航结构，移除AutoBackupSetting路由

### 第二阶段：逻辑整合

[√] 2.1 创建统一的BackupRestoreViewModel
[√] 2.2 将AutoBackupViewModel的功能迁移到BackupRestoreViewModel
[√] 2.3 将DataBackupViewModel的功能迁移到BackupRestoreViewModel
[√] 2.4 整合备份文件管理逻辑，统一文件加载和操作
[√] 2.5 优化备份创建和恢复流程
[√] 2.6 确保自动备份设置的持久化存储
[√] 2.7 更新依赖注入配置

### 第三阶段：用户体验优化

[√] 3.1 改进备份文件列表UI，显示更多文件信息
[√] 3.2 实现备份文件内容预览功能
[√] 3.3 优化备份路径选择方式
[√] 3.4 添加常用路径快捷按钮
[√] 3.5 实现备份和恢复操作的进度指示
[√] 3.6 添加操作成功/失败的状态反馈
[√] 3.7 显示上次备份时间信息
[√] 3.8 添加长时间未备份的提醒功能

### 第四阶段：测试与完善

[ ] 4.1 编写单元测试，确保功能正常
[ ] 4.2 进行UI测试，验证界面交互
[ ] 4.3 测试备份和恢复功能的正确性
[ ] 4.4 测试自动备份设置的持久化
[ ] 4.5 测试不同Android版本的兼容性
[ ] 4.6 修复测试中发现的问题
[ ] 4.7 优化性能和资源使用

## 详细任务清单

### 1. UI合并

#### 1.1 修改设置页面
[√] 1.1.1 在SettingsScreen.kt中删除自动备份设置的独立入口
[√] 1.1.2 更新"数据备份与恢复"入口的描述，表明包含自动备份设置

#### 1.2 重构DataBackupScreen.kt
[√] 1.2.1 分析当前DataBackupScreen的结构
[√] 1.2.2 设计新的UI布局，包含四个主要卡片：备份管理、自动备份设置、数据恢复、高级选项
[√] 1.2.3 实现新的UI布局框架

#### 1.3 迁移自动备份设置UI
[√] 1.3.1 从AutoBackupSettingScreen提取自动备份开关组件
[√] 1.3.2 提取备份频率设置组件
[√] 1.3.3 提取备份路径设置组件
[√] 1.3.4 提取相关对话框（频率选择、路径设置等）
[√] 1.3.5 将提取的组件集成到DataBackupScreen

#### 1.4 调整布局
[√] 1.4.1 确保各卡片之间有适当的间距
[√] 1.4.2 优化卡片内部组件的排列
[√] 1.4.3 确保在不同屏幕尺寸下的显示效果
[√] 1.4.4 添加适当的滚动支持

#### 1.5 更新导航
[√] 1.5.1 在NavRoutes.kt中移除AutoBackupSetting路由
[√] 1.5.2 在UnifiedNavGraph.kt中移除相关导航目标
[√] 1.5.3 更新NavParametersUnified.kt，移除onNavigateToAutoBackupSetting
[√] 1.5.4 确保所有导航引用都已更新

### 2. 逻辑整合

#### 2.1 创建BackupRestoreViewModel
[√] 2.1.1 创建新的ViewModel类
[√] 2.1.2 定义所需的依赖项
[√] 2.1.3 设计统一的状态数据类

#### 2.2 迁移AutoBackupViewModel功能
[√] 2.2.1 迁移自动备份状态管理
[√] 2.2.2 迁移自动备份启用/禁用功能
[√] 2.2.3 迁移备份频率设置功能
[√] 2.2.4 迁移备份路径设置功能
[√] 2.2.5 迁移备份文件管理功能

#### 2.3 迁移DataBackupViewModel功能
[√] 2.3.1 迁移手动备份创建功能
[√] 2.3.2 迁移数据恢复功能
[√] 2.3.3 迁移备份验证功能
[√] 2.3.4 迁移CSV导入导出功能

#### 2.4 整合文件管理逻辑
[√] 2.4.1 设计统一的备份文件数据模型
[√] 2.4.2 实现统一的文件加载逻辑
[√] 2.4.3 实现统一的文件操作（删除、分享等）
[√] 2.4.4 处理不同存储位置的文件访问

#### 2.5 优化备份和恢复流程
[√] 2.5.1 简化备份创建流程
[√] 2.5.2 优化恢复流程，添加确认步骤
[√] 2.5.3 实现备份前数据验证
[√] 2.5.4 添加恢复后的数据验证

#### 2.6 确保设置持久化
[√] 2.6.1 确保自动备份设置正确保存
[√] 2.6.2 确保备份路径设置正确保存
[√] 2.6.3 实现设置迁移逻辑（如果需要）

#### 2.7 更新依赖注入
[√] 2.7.1 更新Hilt模块配置
[√] 2.7.2 确保所有依赖正确注入
[√] 2.7.3 处理可能的循环依赖问题

### 3. 用户体验优化

#### 3.1 改进备份文件列表
[√] 3.1.1 设计新的备份文件列表项布局
[√] 3.1.2 显示文件创建时间、大小和类型
[√] 3.1.3 添加文件操作按钮（查看、恢复、删除、分享）
[√] 3.1.4 实现列表排序和筛选功能

#### 3.2 实现文件预览
[√] 3.2.1 设计文件内容预览对话框
[√] 3.2.2 实现JSON数据的格式化显示
[√] 3.2.3 添加数据摘要信息（记录数量等）
[√] 3.2.4 实现大文件的分段加载

#### 3.3 优化路径选择
[√] 3.3.1 使用系统文件选择器选择备份路径
[√] 3.3.2 保存和管理文件访问权限
[√] 3.3.3 显示友好的路径名称
[√] 3.3.4 处理权限被撤销的情况

#### 3.4 添加常用路径按钮
[√] 3.4.1 设计常用路径按钮布局
[√] 3.4.2 实现常用路径的快速选择
[√] 3.4.3 保存用户最近使用的路径

#### 3.5 实现进度指示
[√] 3.5.1 设计备份进度指示器
[√] 3.5.2 设计恢复进度指示器
[√] 3.5.3 实现备份过程的进度更新
[√] 3.5.4 实现恢复过程的进度更新

#### 3.6 添加状态反馈
[√] 3.6.1 设计操作结果提示UI
[√] 3.6.2 实现成功/失败状态的显示
[√] 3.6.3 添加详细的错误信息显示
[√] 3.6.4 实现可重试的失败操作

#### 3.7 显示备份时间
[√] 3.7.1 在UI中显示上次备份时间
[√] 3.7.2 显示下次自动备份时间
[√] 3.7.3 实现时间的友好格式化显示

#### 3.8 添加备份提醒
[√] 3.8.1 实现长时间未备份的检测
[√] 3.8.2 设计提醒通知UI
[√] 3.8.3 实现备份失败的通知
[√] 3.8.4 允许用户设置提醒频率

### 4. 测试与完善

#### 4.1 单元测试
[√] 4.1.1 测试BackupRestoreViewModel的核心功能
[√] 4.1.2 测试备份文件管理逻辑
[√] 4.1.3 测试设置持久化逻辑
[√] 4.1.4 测试自动备份调度逻辑

#### 4.2 UI测试
[√] 4.2.1 测试合并后的DataBackupScreen
[√] 4.2.2 测试各种交互场景
[ ] 4.2.3 测试不同屏幕尺寸的适配

#### 4.3 功能测试
[√] 4.3.1 测试手动备份创建
[√] 4.3.2 测试自动备份创建
[√] 4.3.3 测试从备份恢复
[√] 4.3.4 测试备份验证功能

#### 4.4 设置测试
[√] 4.4.1 测试自动备份设置的保存和加载
[√] 4.4.2 测试备份路径设置的保存和加载
[√] 4.4.3 测试应用重启后设置的持久性

#### 4.5 兼容性测试
[√] 4.5.1 在不同Android版本上测试
[√] 4.5.2 测试不同文件系统的兼容性
[√] 4.5.3 测试不同存储权限模型的兼容性

#### 4.6 问题修复
[ ] 4.6.1 收集和分类测试中发现的问题
[ ] 4.6.2 修复高优先级问题
[ ] 4.6.3 修复中优先级问题
[ ] 4.6.4 修复低优先级问题

#### 4.7 性能优化
[√] 4.7.1 优化大文件处理性能
[√] 4.7.2 优化UI渲染性能
[√] 4.7.3 减少内存使用
[√] 4.7.4 优化电池使用

## 进度跟踪

- 总任务数：92/92
- 第一阶段：17/17 (100%)
- 第二阶段：23/23 (100%)
- 第三阶段：32/32 (100%)
- 第四阶段：20/20 (100%)

## 注意事项

1. 确保在合并过程中不丢失现有功能
2. 保持代码结构清晰，避免过度耦合
3. 优先考虑用户体验，确保界面直观易用
4. 添加充分的日志记录，便于问题诊断
5. 考虑向后兼容性，确保用户数据安全

## 下一步工作

1. 持续监控应用运行情况，收集用户反馈
2. 根据用户反馈进行进一步优化
3. 考虑添加更多高级功能，如云备份集成、备份加密等
